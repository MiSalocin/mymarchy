#!/bin/bash

# Default temperature values
ON_TEMP=4000
OFF_TEMP=6000

# Ensure hyprsunset is running
if ! pgrep -x hyprsunset; then
  setsid uwsm-app -- hyprsunset &
  sleep 1 # Give it time to register
fi

# Query the current temperature
CURRENT_TEMP=$(hyprctl hyprsunset temperature 2>/dev/null | grep -oE '[0-9]+')

restart_nightlighted_waybar() {
  if grep -q "custom/nightlight" ~/.config/waybar/config.jsonc; then
    myarchy-restart-waybar # restart waybar in case user has waybar module for hyprsunset
  fi
}

# Check if an argument was passed
if [[ -n "$1" ]]; then
  # Argument provided: adjust temperature by the given amount
  ADJUSTMENT=$1
  NEW_TEMP=$((CURRENT_TEMP + ADJUSTMENT))

  # Clamp temperature to reasonable bounds (1000-10000K)
  if [[ $NEW_TEMP -lt 1000 ]]; then
    NEW_TEMP=1000
  elif [[ $NEW_TEMP -gt 10000 ]]; then
    NEW_TEMP=10000
  fi

  hyprctl hyprsunset temperature $NEW_TEMP
  notify-send -h string:x-canonical-private-synchronous:hyprsunset "üå°Ô∏è Temperature adjusted" "New temperature: ${NEW_TEMP}K"
  restart_nightlighted_waybar
else
  # No argument: toggle between ON and OFF temperatures
  if [[ "$CURRENT_TEMP" == "$OFF_TEMP" ]]; then
    hyprctl hyprsunset temperature $ON_TEMP
    notify-send -h string:x-canonical-private-synchronous:hyprsunset "üåô Nightlight screen temperature"
    restart_nightlighted_waybar
  else
    hyprctl hyprsunset temperature $OFF_TEMP
    notify-send -h string:x-canonical-private-synchronous:hyprsunset "‚òÄÔ∏è  Daylight screen temperature"
    restart_nightlighted_waybar
  fi
fi
