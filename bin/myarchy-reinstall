#!/bin/bash

set -e

if [ "$EUID" -eq 0 ]; then
  echo "Error: This script should not be run as root"
  exit 1
fi

echo -e "This will reinstall all the default Myarchy packages and reset all default configs.\nWarning: All changes to configs will be lost.\n"

if gum confirm "Are you sure you want to reinstall and lose all config changes?"; then
  echo "Resetting Myarchy repository"
  git clone "https://github.com/misalocin/myarchy.git" ~/.local/share/myarchy-new >/dev/null
  rm -rf $MYARCHY_PATH
  mv ~/.local/share/myarchy-new $MYARCHY_PATH

  echo "Reinstalling missing Myarchy packages"
  mapfile -t packages < <(grep -v '^#' "$MYARCHY_PATH/install/myarchy-base.packages" | grep -v '^$')
  sudo pacman -Syu --noconfirm --needed "${packages[@]}"

  echo "Resetting all Myarchy configs"
  cp -R ~/.local/share/myarchy/config/* ~/.config/
  cp ~/.local/share/myarchy/default/zshrc ~/.zshrc
  echo '[[ -f ~/.zshrc ]] && . ~/.zshrc' | tee ~/.zsh_profile >/dev/null

  $(bash $MYARCHY_PATH/install/config/theme.sh)
  $(bash $MYARCHY_PATH/install/config/git.sh)
  $(bash $MYARCHY_PATH/install/config/nvim.sh)
  $(bash $MYARCHY_PATH/install/config/terminal.sh)

  myarchy-refresh-limine
  myarchy-refresh-plymouth
fi
